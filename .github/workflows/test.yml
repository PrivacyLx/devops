name: test

on: [push, pull_request]

jobs:
  ansible-molecule:
    runs-on: macos-10.15
    defaults:
      run:
        working-directory: ci
    strategy:
      matrix:
        ansible-role:
          - bigbluebutton
          - discourse
          - mailcow
          - matterbridge
          - update

    # https://github.com/jonashackt/molecule-ansible-docker-aws#use-vagrant-on-github-actions-to-execute-molecule
    steps:
    - uses: actions/checkout@v2

    - name: Debug test XXXX
      env:
        ROLE_PATH: ${GITHUB_WORKSPACE}/ansible/roles/${{ matrix.ansible-role }}
        ROLE_PATH_ENV: ${{ env.GITHUB_WORKSPACE }}/ansible/roles/${{ matrix.ansible-role }}
      run: |
        echo "${ROLE_PATH}"
        echo "${ROLE_PATH_ENV}"

    - name: Cache pipenv virtualenvs incl. all pip packages
      uses: actions/cache@v2
      with:
        path: ~/.local/share/virtualenvs
        key: ${{ runner.os }}-pipenv-${{ hashFiles('**/Pipfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pipenv-

    - uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: Cache Vagrant boxes
      uses: actions/cache@v2
      with:
        path: ~/.vagrant.d/boxes
        key: ${{ runner.os }}-vagrant-${{ hashFiles('Vagrantfile') }}
        restore-keys: |
          ${{ runner.os }}-vagrant-

    - name: Show Vagrant version
      run: vagrant --version

    - name: Install required dependecies with pipenv
      run: |
        pip install pipenv
        pipenv install
        pipenv check

    - name: Testing ansible playbook `deploy-${{ matrix.ansible-role }}`
      env:
        ROLE_PATH: ${GITHUB_WORKSPACE}/ansible/roles/${{ matrix.ansible-role }}
      run: |
        pipenv run molecule lint {ROLE_PATH}
        pipenv run molecule syntax {ROLE_PATH}
        pipenv run molecule converge {ROLE_PATH}
        pipenv run molecule idempotence {ROLE_PATH}
