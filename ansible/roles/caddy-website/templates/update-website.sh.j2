#!/bin/sh
# /!| File autogenerated by ansible deployment

# Builds a hugo website from source using a hugo docker container,
# and restarts the caddy server. The script is ran as superuser
# by a less previledged user because of the setuid.
#
# This happens as a workaround for the fact that the hugo docker
# image produces outputs from the root user. FIXME: correct that

set -e

# build the website from source and leave it in a temp. directory
docker run --name hugo \
          --volume={{ hugo_src_website }}:/src \
          --volume={{ tmp_build.path }}:/output \
          jojomi/hugo:0.52

# remove the docker image so it can be instantiated again
docker rm -f hugo

cp -r {{ tmp_build.path }} {{ caddy_website_root }}

# adjust the permissions left wrongly by the docker container
chown -R caddy:caddy {{ caddy_website_root }}
