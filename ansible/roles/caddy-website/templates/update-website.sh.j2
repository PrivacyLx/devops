#!/bin/sh
# /!| File autogenerated by ansible deployment

# Builds a hugo website from source using a hugo docker container,
# and restarts the caddy server. The script is ran as superuser
# by a less previledged user because of the setuid.
#
# This happens as a workaround for the fact that the hugo docker
# image produces outputs from the root user. FIXME: correct that

tmp_build=$(mktemp -d) # temporary build directory
input_dir={{ hugo_src_website }}
output_dir=$tmp_build
set -e

# update website
cd $input_dir
git pull

# remove the previous docker images
docker rm -f hugo

# build the website from source and leave it in a temp. directory
# this container is ran with the privileges of caddy:caddy
docker run --name hugo \
          --user `id -u caddy`:`id -g caddy` \
          --volume=$input_dir:/src \
          --volume=$output_dir:/output \
          {{ hugo_docker_image }}

# adjust the permissions left wrongly by the docker container
#chown -R caddy:caddy $output_dir

cp -r $output_dir/* {{ caddy_website_root }}
rm -r $output_dir
