---

- name: Creates Discourse directory {{ dis_path }}
  file:
    path: "{{ dis_path }}"
    state: directory

- name: Clones Discourse git repository
  git:
    repo: "{{ dis_git }}"
    dest: "{{ dis_path }}"

- name: Templates Discourse container configuration
  template:
    src: standalone.yml.j2
    dest: "{{ dis_path }}/containers/app.yml"
  register: dis_template

- name: Get Discourse container info
  docker_container_info:
    name: app
  register: dis_ct

- name: Print the status of the Discourse container
  debug:
    msg: "The container status is {{ dis_ct.container.State.Status }}"
  when: dis_ct.exists

- name: (Re)build Discourse container configuration
  command: "{{ dis_path }}/launcher rebuild app"
  when: not dis_ct.exists or dis_template.changed

- name: Start Discourse container if it's not running
  command: "{{ dis_path }}/launcher start app"
  when:
    - not dis_template.changed
    - dis_ct.exists
    - dis_ct.container.State.Status != 'running'
